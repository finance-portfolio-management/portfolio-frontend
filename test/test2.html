<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Portfolio</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for a modern and clean typeface -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Link to external CSS file -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* 全局应用 Inter 字体 */
            background-color: #f0f2f5;
            /* 页面背景色为浅灰色 */
            padding: 0.5rem 0.75rem;
            /* 调整 body 填充，使其更紧凑 (p-2 md:p-4) */
        }

        @media (min-width: 768px) {

            /* 针对中等及以上屏幕 */
            body {
                padding: 0.75rem 1rem;
                /* 调整 body 填充，使其更紧凑 */
            }
        }

        /* 投资类别内可折叠列表项的样式 */
        .investment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            /* 调整内边距，使其更紧凑 */
            border-bottom: 1px solid #e5e7eb;
            /* 浅灰色边框用于分隔 */
        }

        .investment-item:last-child {
            border-bottom: none;
            /* 最后一个项目无下边框 */
        }

        /* 可折叠内容的纯 CSS 逻辑 */
        /* 隐藏 checkbox 输入框 */
        .collapsible-checkbox {
            display: none;
        }

        /* 可折叠内容隐藏时的样式 */
        .collapsible-content {
            max-height: 0;
            /* 初始隐藏 */
            overflow: hidden;
            /* 保持 max-height 的平滑过渡 */
            transition: max-height 0.3s ease-out;
            background-color: #ffffff;
            /* 折叠内容背景色为白色 */
            border-radius: 0 0 0.5rem 0.5rem;
            /* 圆角底部 */
        }

        /* 旋转箭头图标的样式 */
        .chevron-rotated {
            transform: rotate(180deg);
        }

        /* 市场趋势时间范围选择器中活动按钮的样式 */
        .btn-active {
            background-color: #3B82F6 !important;
            /* Tailwind 的 bg-blue-600 */
            color: white !important;
            /* 活动按钮文本为白色 */
        }

        /* 日期选择器输入框的自定义样式，使其与整体设计更匹配 */
        input[type="date"] {
            background-color: #f9fafb;
            /* 最浅的灰色背景 */
            border: 1px solid #d1d5db;
            /* 浅灰色边框 */
            color: #111827;
            /* 深色文本 */
            font-size: 0.875rem;
            /* 小字号 */
            border-radius: 0.5rem;
            /* 圆角 */
            padding: 0.5rem;
            /* 内边距 */
        }
    </style>
</head>

<body class="p-2 md:p-4">

    <div class="max-w-screen-2xl mx-auto">
        <!-- Header Section: Title, Date Picker, User Info, Sign Out Button -->
        <header class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-3">
                <!-- Financial Icon (SVG) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-600" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <h1 class="text-xl font-bold text-gray-800">Finance Portfolio</h1>
                <!-- Date Picker Input -->
                <input type="date" id="date-picker" class="ml-2">
            </div>
            <div class="flex items-center gap-3">
                <span class="font-medium text-gray-700 text-sm">Boss</span>
                <button
                    class="px-3 py-1.5 text-xs font-semibold text-gray-600 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">
                    Sign out
                </button>
            </div>
        </header>

        <!-- Main Content Area: Divided into two columns -->
        <main class="flex flex-col lg:flex-row gap-2">

            <!-- Left Column: Net Worth, Asset Distribution, Market Trends, Top Gainers/Losers -->
            <div class="flex-grow flex flex-col gap-2">
                <!-- Top Row: Net Worth and Asset Distribution Cards -->
                <div class="flex flex-col md:flex-row gap-2">
                    <!-- Net Worth Card -->
                    <div class="flex-1 bg-white p-4 rounded-lg shadow-sm flex flex-col justify-between">
                        <div class="flex justify-between w-full">
                            <div class="text-left">
                                <p class="text-xs text-gray-500">Net Worth</p>
                                <p id="net-worth-value" class="text-3xl font-bold text-gray-800">Loading...</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">Cumulative income</p>
                                <p id="cumulative-income-value"
                                    class="text-lg font-bold bg-blue-400 text-white px-2 py-1 rounded-md shadow-md inline-block">
                                    Loading...</p>
                            </div>
                        </div>
                        <!-- ECharts container for Growth Rate Gauge -->
                        <div id="growth-rate-chart" class="w-full h-40 mt-2 self-center"></div>
                    </div>
                    <!-- Asset Distribution Card -->
                    <div class="flex-1 bg-white p-4 rounded-lg shadow-sm">
                        <h2 class="font-bold text-base text-gray-800 mb-3">Asset Distribution</h2>
                        <!-- ECharts container for Asset Distribution Pie Chart -->
                        <div id="asset-distribution-chart" class="w-full h-56"></div>
                    </div>
                </div>

                <!-- Market Trends Card: Candlestick Chart and Time Range Selector -->
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="font-bold text-base text-gray-800">Market Trends</h2>
                        <div class="flex items-center gap-1">
                            <!-- Company Search Input -->
                            <input id="CompTrendSearch" type="text" placeholder="Search for Companies"
                                class="px-2 py-1 border border-gray-300 rounded-md text-xs w-36">
                            <!-- Time Range Selection Buttons -->
                            <div id="time-range-selector" class="flex border border-gray-200 rounded-md">
                                <button data-range="1D"
                                    class="px-2 py-1 text-xs hover:bg-gray-100 rounded-l-md">1D</button>
                                <button data-range="1W" class="px-2 py-1 text-xs hover:bg-gray-100">1W</button>
                                <button data-range="1M" class="px-2 py-1 text-xs hover:bg-gray-100">1M</button>
                                <button data-range="3M"
                                    class="px-2 py-1 text-xs hover:bg-gray-100 rounded-r-md btn-active">3M</button>
                            </div>
                        </div>
                    </div>
                    <!-- ECharts container for Market Trends Candlestick Chart -->
                    <div id="market-trends-chart" class="w-full h-64"></div>
                </div>

                <!-- Top Gainers/Losers Cards -->
                <div class="flex flex-col md:flex-row gap-2">
                    <!-- Top Gainers Section -->
                    <div class="flex-1 bg-white p-3 rounded-lg shadow-sm">
                        <h2 class="font-bold text-base text-gray-800 mb-3">Top gainers</h2>
                        <div id="top-gainers-list" class="space-y-1">
                            <!-- Top Gainer items will be injected here by JavaScript -->
                            <p class="text-gray-500 text-sm">Loading...</p>
                        </div>
                    </div>
                    <!-- Top Losers Section -->
                    <div class="flex-1 bg-white p-3 rounded-lg shadow-sm">
                        <h2 class="font-bold text-base text-gray-800 mb-3">Top losers</h2>
                        <div id="top-losers-list" class="space-y-1">
                            <!-- Top Loser items will be injected here by JavaScript -->
                            <p class="text-gray-500 text-sm">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Investment List with Collapsible Categories -->
            <div class="w-full lg:w-96 flex-shrink-0">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h2 class="font-bold text-lg text-gray-800 mb-4 px-2">Investment List</h2>
                    <div id="investment-list" class="space-y-2">
                        <!-- Investment categories will be injected here by JavaScript -->
                        <p class="text-gray-500 text-sm px-2">Loading...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer Section: Investment Advice Carousel and Risk Warning -->
        <footer class="mt-2 space-y-1">
            <div class="bg-blue-600 text-white p-3 rounded-lg shadow-sm flex items-start gap-3">
                <!-- Info Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0 mt-0.5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <!-- Investment Advice Carousel -->
                <div class="h-6 overflow-hidden flex-grow">
                    <div id="advice-carousel" class="transition-transform duration-500 ease-in-out">
                        <p class="h-6 leading-6 text-sm"><strong>Investment Advice:</strong> Diversification reduces
                            risk - spread
                            your assets across different sectors.</p>
                        <p class="h-6 leading-6 text-sm"><strong>Long-term View:</strong> Don't panic during market
                            dips; successful
                            investing is often a marathon, not a sprint.</p>
                        <p class="h-6 leading-6 text-sm"><strong>Stay Informed:</strong> Regularly review your portfolio
                            and stay
                            updated on market news and trends.</p>
                    </div>
                </div>
            </div>
            <!-- Risk Warning -->
            <div class="text-xs text-gray-500 p-3 bg-white rounded-lg shadow-sm">
                <p><strong>Risk Warning:</strong> The market is risky, so be cautious when investing. The data in this
                    report is
                    for reference only and does not constitute any investment advice. The investment value and its
                    returns may
                    fluctuate, and past performance does not represent future performance.</p>
            </div>
        </footer>

    </div>

    <!-- Link to external JavaScript file -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script type="module">
        import { getSingleHistoricalAsset } from '../scripts/api/assetsHistoryAPI.js';
        import { addAssets } from '../scripts/api/assetsAPI.js';

        document.addEventListener('DOMContentLoaded', function () {
            function splitData(rawData) {
                let categoryData = []; // Dates/Times
                let values = []; // Open, Close, Low, High values
                let dataToProcess = JSON.parse(JSON.stringify(rawData)); // Deep copy to avoid modifying original

                for (let i = 0; i < dataToProcess.length; i++) {
                    categoryData.push(dataToProcess[i].splice(0, 1)[0]); // Extract date/time
                    values.push(dataToProcess[i]); // Remaining values are OHLC
                }
                // console.log('Splitting data:', values);

                return { categoryData, values };
            }


            // Function to filter data for specific ranges relative to a reference end date
            function filterDataByRange(data, days, referenceEndDate) {
                const endDate = new Date(referenceEndDate);
                const startDate = new Date(endDate);
                startDate.setDate(endDate.getDate() - days);

                return data.filter(item => {
                    const itemDate = new Date(item[0]);
                    return itemDate >= startDate && itemDate <= endDate;
                });
            }
            document.getElementById('CompTrendSearch').addEventListener('keydown', async function (event) {
                if (event.key === 'Enter') {
                    const currentDate = document.getElementById('date-picker').value;

                    const selector = document.getElementById('time-range-selector');
                    const buttons = selector.querySelectorAll('button');
                    buttons.forEach(btn => btn.classList.remove('btn-active')); // 移除所有active
                    const targetButton = selector.querySelector('button[data-range="3M"]');
                    if (targetButton) {
                        targetButton.classList.add('btn-active');
                    }
                    await addAssets({
                        symbol: event.target.value,
                    }).then(() => {
                        refreshMarketTrendsData(currentDate, event.target.value);

                    }).catch((error) => {
                        console.error('Failed to add asset:', error);
                    })

                    // refreshMarketTrendsData(currentDate, event.target.value);
                    event.target.value = ''; // 清空输入框

                }

            });



            async function refreshMarketTrendsData(currentEndDate, symbol) {
                return new Promise(async (resolve, reject) => {
                    try {
                        const date = new Date(currentEndDate);
                        date.setDate(date.getDate() - 90);
                        const result = date.toISOString().split("T")[0];
                        const payload = {
                            symbol: symbol,
                            start: result,
                            end: currentEndDate
                        };

                        const marketTrendsData = await getSingleHistoricalAsset(payload);
                        const transformed = marketTrendsData.data.map(item => {
                            const dateOnly = item.date.split(' ')[0];
                            return [
                                dateOnly,
                                parseFloat(item.open),
                                parseFloat(item.close),
                                parseFloat(item.low),
                                parseFloat(item.high)
                            ];
                        });

                        const marketTrendsDataFormat = {
                            '1D': filterDataByRange(transformed, 1, currentEndDate),
                            '1W': filterDataByRange(transformed, 7, currentEndDate),
                            '1M': filterDataByRange(transformed, 30, currentEndDate),
                            '3M': filterDataByRange(transformed, 90, currentEndDate)
                        };
                        if (!window.dashboardData) {
                            window.dashboardData = {}; // 先初始化对象
                        }

                        window.dashboardData.marketTrendsData = marketTrendsDataFormat;
                        window.dashboardData.symbol = symbol; // Store the symbol for later use


                        updateMarketChart(marketTrendsDataFormat, '3M', symbol); // Default to 1D view
                        resolve(marketTrendsDataFormat);
                    } catch (error) {
                        console.error('Failed to refresh market trends data:', error);
                        reject(error);
                    }
                });

            }


            function updateMarketChart(marketTrendsData, range, symbol = "AAPL") {
                const upColor = '#00da3c'; // Up color (green)
                const downColor = '#ec0000'; // Down color (red)
                const data = splitData(marketTrendsData[range]);
                const marketTrendsChart = echarts.init(document.getElementById('market-trends-chart'));

                if (data.values.length === 0) {
                    marketTrendsChart.clear();
                    marketTrendsChart.setOption({
                        graphic: [{
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: 'No data available for this range',
                                textAlign: 'center',
                                fontSize: 20,
                                fill: '#888'
                            }
                        }]
                    });
                    return;
                }

                const marketTrendsOption = {
                    tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                    title: {
                        text: `${symbol.toUpperCase()}`,
                        left: 'left', // Center the title
                        textStyle: { fontSize: 20, fontWeight: 'bold' } // Adjust title font size and weight
                    },
                    legend: { // Add legend for Candlestick and MAs
                        data: ['Candlestick'],
                        top: 0, // Position legend at the top
                        selectedMode: 'multiple', // Allow multiple selection
                        itemGap: 10, // Adjust legend item spacing
                        textStyle: { fontSize: 12 } // Adjust legend font size
                    },
                    grid: { left: '10%', right: '10%', bottom: '15%' },
                    xAxis: {
                        type: 'category',
                        data: data.categoryData,
                        axisLabel: {
                            formatter: function (value) {
                                // Format date to YYYY/MM/DD, similar to the image
                                return value.split(' ')[0].replace(/-/g, '/');
                            },
                            fontSize: 10 // Adjust X-axis label font size
                        }
                    },
                    yAxis: { scale: true, splitArea: { show: true }, axisLabel: { fontSize: 10 } }, // Adjust Y-axis label font size
                    dataZoom: [{ type: 'inside', start: 0, end: 100 }, { show: true, type: 'slider', top: '90%', start: 0, end: 100 }],
                    series: [
                        { name: 'Candlestick', type: 'candlestick', data: data.values, itemStyle: { color: upColor, color0: downColor, borderColor: upColor, borderColor0: downColor } },
                    ]
                };

                marketTrendsChart.setOption(marketTrendsOption, true);
            }
            async function getTopGainersAndLosers() {
                return new Promise(async (resolve, reject) => {
                    try {

                        const response = await fetch('http://localhost:3000/api/market/top-gainers-losers', {
                            method: 'GET'
                        });


                        const data = await response.json()
                        if (!response.ok) {
                            throw new Error(data.error);
                        }


                        resolve(data);

                    } catch (error) {
                        console.error('Failed to get assets:', error);
                        resolve(error);
                    }
                });
            }
            function renderTopMovers(data) {
                const topGainersList = document.getElementById('top-gainers-list');
                const topLosersList = document.getElementById('top-losers-list');

                topGainersList.innerHTML = ''; // Clear existing content
                topLosersList.innerHTML = ''; // Clear existing content

                data.topGainers.forEach(item => {
                    const changePrice = Math.abs(parseFloat(item.currentPrice) / (1 + parseFloat(item.growthRate) / 100) - parseFloat(item.currentPrice));

                    const itemHtml = `
                          <div class="flex items-center justify-between">
                              <div class="flex flex-col items-start">
                                  <span class="font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded mb-1 text-sm">${item.symbol}</span>
                                  <div>
                                      <p class="font-semibold text-gray-700 text-sm">${item.name}</p>
                                      <p class="text-xs text-gray-500">${parseFloat(item.currentPrice).toFixed(2)}</p>
                                  </div>
                              </div>
                              <div class="text-right">
                                  <p class="font-semibold text-green-600 text-sm">${changePrice.toFixed(2)} (${parseFloat(item.growthRate).toFixed(2)}%)</p>
                                  <div class="h-1.5 w-16 bg-green-200 rounded-full mt-0.5"><div class="h-1.5 bg-green-500 rounded-full" style="width: 80%"></div></div>
                              </div>
                          </div>
                      `;
                    topGainersList.insertAdjacentHTML('beforeend', itemHtml);
                });

                data.topLosers.forEach(item => {
                    // console.log(item);
                    const changePrice = Math.abs(parseFloat(item.currentPrice) / (1 + parseFloat(item.growthRate) / 100) - parseFloat(item.currentPrice));

                    const itemHtml = `
                          <div class="flex items-center justify-between">
                              <div class="flex flex-col items-start">
                                  <span class="font-bold text-red-600 bg-red-100 px-2 py-1 rounded mb-1 text-sm">${item.symbol}</span>
                                  <div>
                                      <p class="font-semibold text-gray-700 text-sm">${item.name}</p>
                                      <p class="text-xs text-gray-500">${parseFloat(item.currentPrice).toFixed(2)}</p>
                                  </div>
                              </div>
                              <div class="text-right">
                                  <p class="font-semibold text-red-600 text-sm">${changePrice.toFixed(2)} (${parseFloat(item.growthRate).toFixed(2)}%)</p>
                                  <div class="h-1.5 w-16 bg-red-200 rounded-full mt-0.5"><div class="h-1.5 bg-red-500 rounded-full" style="width: 80%"></div></div>
                              </div>
                          </div>
                      `;
                    topLosersList.insertAdjacentHTML('beforeend', itemHtml);
                });
            }
            document.getElementById('date-picker').addEventListener('change', (e) => {
                let tempSymbol = "AAPL";
                if (window.dashboardData) {
                    tempSymbol = window.dashboardData.symbol || "AAPL"; // Use stored symbol or default to AAPL
                }
                const selector = document.getElementById('time-range-selector');
                const buttons = selector.querySelectorAll('button');
                buttons.forEach(btn => btn.classList.remove('btn-active'));
                const targetButton = selector.querySelector('button[data-range="3M"]');
                if (targetButton) {
                    targetButton.classList.add('btn-active');
                }
                refreshMarketTrendsData(e.target.value, tempSymbol);
            });

            // --- Set Date Picker to Today's Date ---
            const datePicker = document.getElementById('date-picker');
            if (datePicker) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed, so add 1
                const dd = String(today.getDate()).padStart(2, '0');
                datePicker.value = `${yyyy}-${mm}-${dd}`; // Format as YYYY-MM-DD
            }

            // --- ECharts Initialization ---

            // 1. Growth Rate Gauge
            const growthRateChart = echarts.init(document.getElementById('growth-rate-chart'));
            const growthRateOption = {
                title: { // Main title for the entire chart
                    text: 'Growth Rate',
                    left: 'left', // Title aligned to the left
                    top: 'top',   // Title aligned to the top
                    textStyle: {
                        color: '#333', // Title text color
                        fontSize: 14, // Adjust font size
                        fontWeight: 'bold'
                    }
                },
                series: [{
                    type: 'gauge',
                    center: ['50%', '60%'], // Gauge center position
                    radius: '95%', // Gauge size
                    startAngle: 200, // Start angle of the gauge arc
                    endAngle: -20, // End angle of the gauge arc
                    min: -10, // Allow negative growth
                    max: 10,
                    splitNumber: 5, // Simplified number of scale marks
                    progress: { show: true, width: 8 }, // Simplified progress bar width
                    pointer: { show: false }, // Hide pointer
                    axisLine: { lineStyle: { width: 8 } }, // Simplified axis line width
                    axisTick: { show: false }, // Hide ticks
                    splitLine: { show: false }, // Hide split lines
                    axisLabel: { distance: -5, color: '#999', fontSize: 10 }, // Adjust label distance and font size
                    anchor: { show: false }, // Hide anchor point
                    detail: {
                        valueAnimation: true, // Value change animation
                        fontSize: 16,
                        fontWeight: 'bold',
                        offsetCenter: [0, '0%'], // Detail text position
                        formatter: function (value) {
                            return 'Growth Rate\n' + value.toFixed(1) + '%'; // Format displayed value
                        }
                    },
                    data: [{ value: 0 }] // Initial value for the gauge (will be updated by fetched data)
                }]
            };
            growthRateChart.setOption(growthRateOption);

            // 2. Asset Distribution Pie Chart (Nightingale Chart)
            const assetDistributionChart = echarts.init(document.getElementById('asset-distribution-chart'));
            // 3. Market Trends Candlestick Chart 


            // Event listener for time range selector buttons
            const timeRangeSelector = document.getElementById('time-range-selector');
            timeRangeSelector.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    // Remove active class from all buttons
                    timeRangeSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('btn-active'));
                    // Add active class to the clicked button
                    e.target.classList.add('btn-active');
                }
            });

            // Render Investment List
            function renderInvestmentList(data) {
                const investmentListContainer = document.getElementById('investment-list');
                investmentListContainer.innerHTML = ''; // Clear existing content

                const pieChartData = []; // Data for ECharts pie chart

                data.forEach((group, index) => {
                    const sectionContainer = document.createElement('div');
                    const checkboxId = `collapsible-${group.category.toLowerCase().replace(/\s/g, '-')}`;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = checkboxId;
                    checkbox.className = 'collapsible-checkbox';
                    sectionContainer.appendChild(checkbox);

                    const headerLabel = document.createElement('label');
                    headerLabel.htmlFor = checkboxId;
                    headerLabel.className = `p-3 rounded-lg flex justify-between items-center cursor-pointer bg-${group.color}-100 collapsible-header`;
                    headerLabel.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="w-2.5 h-2.5 rounded-full bg-${group.color}-500"></span>
                            <span class="font-bold text-gray-800 text-sm">${group.category}</span>
                            <span class="text-xs text-gray-600">¥${group.categoryValue.toFixed(2)}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-gray-700 text-sm">${group.categoryPercentage.toFixed(2)}%</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 transition-transform chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    `;
                    sectionContainer.appendChild(headerLabel);

                    const content = document.createElement('div');
                    content.className = 'collapsible-content';
                    group.items.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'investment-item';
                        itemEl.innerHTML = `
                            <span class="font-medium text-gray-700 text-sm">${item.name}</span>
                            <span class="text-xs text-gray-500">¥${item.value.toFixed(2)} (${item.percentage.toFixed(2)}%)</span>
                        `;
                        content.appendChild(itemEl);
                    });
                    sectionContainer.appendChild(content);

                    checkbox.addEventListener('change', () => {
                        const chevron = headerLabel.querySelector('.chevron');
                        if (checkbox.checked) {
                            content.style.maxHeight = content.scrollHeight + 'px';
                            chevron.classList.add('chevron-rotated');
                        } else {
                            content.style.maxHeight = '0px';
                            chevron.classList.remove('chevron-rotated');
                        }
                    });

                    // Keep the first category open by default
                    if (index === 0) {
                        checkbox.checked = true;
                        setTimeout(() => {
                            content.style.maxHeight = content.scrollHeight + 'px';
                            headerLabel.querySelector('.chevron').classList.add('chevron-rotated');
                        }, 0);
                    }

                    investmentListContainer.appendChild(sectionContainer);

                    // Prepare data for ECharts pie chart
                    pieChartData.push({
                        value: group.categoryValue,
                        name: group.category
                    });
                });

                // Update ECharts Asset Distribution Pie Chart
                const assetDistributionOption = {
                    tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c} ({d}%)' },
                    legend: { orient: 'vertical', left: 'right', top: 'center', data: data.map(g => g.category), itemGap: 5, textStyle: { fontSize: 12 } },
                    series: [{
                        name: 'Asset Distribution',
                        type: 'pie',
                        radius: [20, 100],
                        center: ['35%', '50%'],
                        roseType: 'radius',
                        avoidLabelOverlap: false,
                        label: { show: false, position: 'center' },
                        emphasis: { label: { show: true, fontSize: '18', fontWeight: 'bold' } },
                        labelLine: { show: false },
                        data: pieChartData
                    }],
                    color: ['#5470C6', '#91CC75', '#FAC858', '#EE6666', '#73C0DE']
                };
                assetDistributionChart.setOption(assetDistributionOption, true); // true for merging options
            }


            // Simulate fetching all dashboard data from the server
            async function fetchDashboardData() {
                const marketTrendsRep = await refreshMarketTrendsData(datePicker.value, 'AAPL'); // Fetch market trends data for the selected date
                // Mock data for Net Worth and Cumulative Income
                const netWorthValue = 1234567.89;
                const cumulativeIncomeValue = 5678.9;
                const growthRateValue = 2.5; // Example growth rate

                // Mock data for Investment List (raw data, will be processed)
                const rawInvestmentListData = [
                    {
                        category: 'Stocks', color: 'blue', items: [
                            { name: 'AAPL', value: 300000.00 },
                            { name: 'GOOG', value: 250000.00 },
                            { name: 'MSFT', value: 150000.00 },
                            { name: 'AMZN', value: 40740.00 }
                        ]
                    },
                    {
                        category: 'Funds', color: 'cyan', items: [
                            { name: 'VTI', value: 150000.00 },
                            { name: 'VXUS', value: 120370.00 },
                            { name: 'BNDX', value: 100000.00 }
                        ]
                    },
                    {
                        category: 'Bonds', color: 'green', items: [
                            { name: 'BND', value: 150000.00 },
                            { name: 'AGG', value: 120370.00 },
                            { name: 'TLT', value: 100000.00 }
                        ]
                    },
                    {
                        category: 'Cash', color: 'yellow', items: [
                            { name: 'USD Savings', value: 80000.00 },
                            { name: 'EUR Current', value: 43450.00 }
                        ]
                    },
                    {
                        category: 'Others', color: 'red', items: [
                            { name: 'Real Estate', value: 30000.00 },
                            { name: 'Crypto', value: 20000.00 },
                            { name: 'Commodities', value: 11720.00 }
                        ]
                    }
                ];

                // Calculate total investment value for accurate percentages
                let totalInvestmentValue = 0;
                rawInvestmentListData.forEach(group => {
                    group.items.forEach(item => {
                        totalInvestmentValue += item.value;
                    });
                });

                const processedInvestmentData = rawInvestmentListData.map(group => {
                    let categoryValue = 0;
                    group.items.forEach(item => {
                        categoryValue += item.value;
                    });
                    const categoryPercentage = (categoryValue / totalInvestmentValue) * 100;

                    const itemsWithPercentage = group.items.map(item => {
                        const itemPercentage = (item.value / totalInvestmentValue) * 100;
                        return { ...item, percentage: itemPercentage };
                    });

                    return {
                        ...group,
                        categoryValue: categoryValue,
                        categoryPercentage: categoryPercentage,
                        items: itemsWithPercentage
                    };
                });

                const topMoversData = await getTopGainersAndLosers(); // Fetch top gainers and losers from AP

                return {
                    symbol: 'AAPL',
                    netWorth: netWorthValue,
                    cumulativeIncome: cumulativeIncomeValue,
                    growthRate: growthRateValue,
                    investmentData: processedInvestmentData,
                    marketTrendsData: marketTrendsRep,
                    topMoversData: topMoversData.data
                };
            }

            // Main execution flow
            fetchDashboardData().then(data => {
                // Store fetched data globally or pass it around
                window.dashboardData = data; // Storing for easier access in event listeners

                // Update Net Worth and Cumulative Income display
                document.getElementById('net-worth-value').textContent = `¥${data.netWorth.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('cumulative-income-value').textContent = `+ ¥${data.cumulativeIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                // Update Growth Rate Chart
                growthRateChart.setOption({ series: [{ data: [{ value: data.growthRate }] }] });

                // Render Investment List and update Asset Distribution Chart
                renderInvestmentList(data.investmentData);

                // Update Market Trends Chart (initial load with 1D data)
                updateMarketChart(data.marketTrendsData, '3M'); // Pass marketTrendsData here

                // Render Top Movers
                renderTopMovers(data.topMoversData);

                // Event listener for time range selector buttons (updated to use fetched data)
                timeRangeSelector.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        updateMarketChart(window.dashboardData.marketTrendsData, e.target.dataset.range, window.dashboardData.symbol); // Use globally stored data
                    }
                });

            }).catch(error => {
                console.error('Failed to fetch dashboard data:', error);
                // Display a user-friendly error message on the page
                document.getElementById('net-worth-value').textContent = 'Error loading data';
                document.getElementById('cumulative-income-value').textContent = 'Error loading data';
                document.getElementById('top-gainers-list').innerHTML = '<p class="text-red-500 text-sm">Failed to load top gainers.</p>';
                document.getElementById('top-losers-list').innerHTML = '<p class="text-red-500 text-sm">Failed to load top losers.</p>';
                document.getElementById('investment-list').innerHTML = '<p class="text-red-500 text-sm px-2">Failed to load investment list.</p>';
            });

        });
    </script>
</body>

</html>